<!DOCTYPE html>
<html lang="fr">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Archives & Rapports | SONAR NC</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
    <link href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.11.0/font/bootstrap-icons.css" rel="stylesheet">
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;600;700;800&display=swap" rel="stylesheet">
    <link href="css/style.css" rel="stylesheet">
</head>
<body class="animate-fade-in">

<header class="hero-sonar text-center" style="background: linear-gradient(135deg, #2c3e50 0%, #1a252f 100%); padding: 60px 0 80px;">
    <div class="container">
        <span class="badge badge-sonar bg-warning text-dark mb-3">ARCHIVES OFFICIELLES</span>
        <h1 class="display-5 fw-bold"><i class="bi bi-folder2-open"></i> Rapports de Surveillance</h1>
        <p class="lead opacity-75">Historique des analyses et verdicts de conformité</p>
    </div>
</header>

<nav class="container nav-sonar">
    <div class="d-flex justify-content-center gap-3 flex-wrap">
        <a href="index.html" class="nav-link-sonar"><i class="bi bi-house-fill"></i> Accueil</a>
        <a href="dashboard-video.html" class="nav-link-sonar"><i class="bi bi-tv-fill"></i> Vidéo</a>
        <a href="dashboard-audio.html" class="nav-link-sonar"><i class="bi bi-mic-fill"></i> Audio</a>
        <a href="rapports.html" class="nav-link-sonar active" style="background: #2c3e50;"><i class="bi bi-folder-check"></i> Rapports</a>
        <a href="contacts.html" class="nav-link-sonar"><i class="bi bi-telephone-fill"></i> Contact</a>
    </div>
</nav>

<main class="container mt-5">
    <div class="glass-card p-4 mb-4">
        <div class="row g-3 align-items-center">
            <div class="col-md-auto">
                <span class="fw-bold text-muted"><i class="bi bi-filter"></i> FILTRER :</span>
            </div>
            <div class="col-md-3">
                <select class="form-select border-0 bg-light shadow-sm" id="filterType" style="border-radius: 10px;">
                    <option value="tous">Toutes les catégories</option>
                    <option value="Video">Vidéo (TV)</option>
                    <option value="Audio">Audio (Radio)</option>
                </select>
            </div>
            <div class="col-md-3">
                <select class="form-select border-0 bg-light shadow-sm" id="filterMedia" style="border-radius: 10px;">
                    <option value="tous">Tous les médias</option>
                    <optgroup label="Télévision">
                        <option value="NC 1ere">NC 1ère TV</option>
                        <option value="Caledonia">Caledonia</option>
                    </optgroup>
                    <optgroup label="Radio">
                        <option value="NC 1ere">NC 1ère Radio</option>
                        <option value="RRB">RRB</option>
                        <option value="NRJ">NRJ</option>
                        <option value="Oceane">Océane FM</option>
                        <option value="Djiido">Radio Djiido</option>
                    </optgroup>
                </select>
            </div>
            <div class="col-md text-end">
                <span class="badge badge-sonar bg-light text-muted" id="rowCount">Chargement des archives...</span>
            </div>
        </div>
    </div>

    <div class="report-table-card shadow-sm">
        <div class="table-responsive">
            <table class="table table-hover mb-0">
                <thead>
                    <tr>
                        <th>Date</th>
                        <th>Type</th>
                        <th>Média</th>
                        <th>Titre du Rapport</th>
                        <th>Verdict IA</th>
                        <th class="text-center">Dossier</th>
                    </tr>
                </thead>
                <tbody id="tableBody"></tbody>
            </table>
        </div>
    </div>
</main>

<div class="modal fade" id="rapportModal" tabindex="-1" aria-hidden="true">
    <div class="modal-dialog modal-lg modal-dialog-centered">
        <div class="modal-content">
            <div class="modal-header px-4">
                <h5 class="modal-title fw-bold" id="rapportModalLabel">Détails du Rapport</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
            </div>
            <div class="modal-body p-4" id="modalContent">
                </div>
            <div class="modal-footer border-0 px-4 pb-4">
                <button type="button" class="btn btn-light fw-bold px-4" data-bs-dismiss="modal">Fermer</button>
                <button type="button" class="btn btn-primary fw-bold px-4" onclick="window.print()"><i class="bi bi-printer"></i> Imprimer PDF</button>
            </div>
        </div>
    </div>
</div>

<footer class="text-center py-4 text-muted mt-5">
    <small>&copy; 2026 SONAR NC - Surveillance du Pluralisme</small>
</footer>

<script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>
<script>
    document.addEventListener('DOMContentLoaded', fetchRapports);
    document.getElementById('filterType').addEventListener('change', applyFilters);
    document.getElementById('filterMedia').addEventListener('change', applyFilters);

    async function fetchRapports() {
        try {
            // Ajout d'un paramètre anti-cache (?t=) pour forcer la lecture du JSON frais
            const response = await fetch('resultats_sonar.json?t=' + Date.now());
            if (!response.ok) throw new Error("Impossible de charger resultats_sonar.json");
            
            const data = await response.json();
            const tableBody = document.getElementById('tableBody');
            tableBody.innerHTML = '';

            // Tri par date décroissante
            data.sort((a,b) => new Date(b.timestamp) - new Date(a.timestamp)).forEach(item => {
                const dateObj = new Date(item.timestamp);
                const dateStr = dateObj.toLocaleDateString('fr-FR');
                const cat = item.type.charAt(0).toUpperCase() + item.type.slice(1);
                const mediaName = getMedia(item);
                
                const verdict = item.analysis_complete ? 
                    '<span class="status-pill status-ok"><i class="bi bi-check-circle"></i> Conforme</span>' : 
                    '<span class="status-pill status-alert"><i class="bi bi-exclamation-triangle"></i> En attente</span>';

                let summary = item.summary || 'Analyse automatique du flux';
                summary = summary.replace(/[#*]/g, ''); 
                const displaySummary = summary.length > 120 ? summary.substring(0, 120) + '...' : summary;

                const row = `
                    <tr>
                        <td class="fw-bold text-muted">${dateStr}</td>
                        <td><span class="badge ${item.type.toLowerCase()==='video'?'badge-video':'badge-audio'}">${cat}</span></td>
                        <td><span class="fw-bold" style="color:#2c3e50">${mediaName}</span></td>
                        <td><span class="text-dark"><strong>Expert :</strong> ${displaySummary}</span></td>
                        <td>${verdict}</td>
                        <td class="text-center">
                            <button class="btn btn-sm btn-dark rounded-pill px-3 shadow-sm" onclick="showDetail(${item.id})">
                                <i class="bi bi-eye"></i> Ouvrir
                            </button>
                        </td>
                    </tr>
                `;
                tableBody.innerHTML += row;
            });
            updateCount();
        } catch (e) { 
            console.error("Erreur d'affichage du tableau:", e);
            document.getElementById('tableBody').innerHTML = `<tr><td colspan="6" class="text-center text-danger p-5">Erreur de chargement des données. Vérifiez resultats_sonar.json.</td></tr>`;
        }
    }

    function getMedia(item) {
        if (item.media && item.media !== "Inconnu") return item.media;
        const f = item.filename ? item.filename.toLowerCase() : '';
        if (item.type.toLowerCase() === 'video') {
            if (f.includes('nc1ere')) return 'NC 1ère TV';
            if (f.includes('caledonia')) return 'Caledonia';
            return 'Télévision NC';
        } else {
            if (f.includes('nc1ere')) return 'NC 1ère Radio';
            if (f.includes('rrb')) return 'RRB';
            if (f.includes('nrj')) return 'NRJ';
            if (f.includes('oceane')) return 'Océane FM';
            if (f.includes('djiido')) return 'Radio Djiido';
            return 'Radio NC';
        }
    }

    async function showDetail(id) {
        const modalEl = document.getElementById('rapportModal');
        const modal = new bootstrap.Modal(modalEl);
        const container = document.getElementById('modalContent');
        
        container.innerHTML = '<div class="text-center p-5"><div class="spinner-border text-primary"></div><p class="mt-2">Récupération du rapport...</p></div>';
        modal.show();

        try {
            const [detailsRes, resultsRes] = await Promise.all([
                fetch('rapports_details.json?t=' + Date.now()),
                fetch('resultats_sonar.json?t=' + Date.now())
            ]);

            if (!detailsRes.ok || !resultsRes.ok) throw new Error("Erreur serveur (fichiers JSON introuvables)");

            const details = await detailsRes.json();
            const results = await resultsRes.json();
            
            // Comparaison stringifiée pour éviter les bugs Number/String
            const rapport = details.find(d => String(d.id) === String(id));
            const basic = results.find(r => String(r.id) === String(id));

            if (!rapport || !basic) {
                container.innerHTML = `<div class="alert alert-warning">Désolé, aucun rapport détaillé n'a été trouvé pour l'ID : ${id}.</div>`;
                return;
            }

            container.innerHTML = `
                <div class="report-detail-box d-flex justify-content-between align-items-center mb-3 bg-light p-3 rounded">
                    <div>
                        <small class="text-muted fw-bold">MÉDIA</small><br>
                        <span class="fw-bold text-primary">${getMedia(basic)}</span>
                    </div>
                    <div class="text-end">
                        <small class="text-muted fw-bold">DATE DU FLUX</small><br>
                        <span class="fw-bold">${new Date(basic.timestamp).toLocaleDateString('fr-FR')}</span>
                    </div>
                </div>
                <h4 class="fw-bold mb-3">${rapport.titre}</h4>
                <p class="text-muted mb-4">${rapport.introduction}</p>
                
                <div class="card border-0 bg-primary bg-opacity-10 p-3 mb-4 rounded-4">
                    <h6 class="fw-bold text-primary"><i class="bi bi-robot"></i> SYNTHÈSE IA SONAR</h6>
                    <p class="mb-0 small">${rapport.verdict_ia}</p>
                </div>

                <div class="row g-4">
                    <div class="col-md-6">
                        <h6 class="fw-bold text-dark border-bottom pb-2"><i class="bi bi-graph-up-arrow text-success"></i> PLURALISME</h6>
                        <ul class="small ps-3 mt-2">
                            ${rapport.analyse_pluralisme.map(li => `<li class="mb-1">${li}</li>`).join('')}
                        </ul>
                    </div>
                    <div class="col-md-6">
                        <h6 class="fw-bold text-dark border-bottom pb-2"><i class="bi bi-lightning-charge text-warning"></i> FAITS MARQUANTS</h6>
                        <ul class="small ps-3 mt-2">
                            ${rapport.faits_marquants.map(li => `<li class="mb-1">${li}</li>`).join('')}
                        </ul>
                    </div>
                </div>
            `;
        } catch(e) { 
            console.error("Détails de l'erreur:", e);
            container.innerHTML = `
                <div class="text-center p-4">
                    <i class="bi bi-x-circle text-danger display-4"></i>
                    <p class="mt-3 fw-bold">Erreur de lecture des données</p>
                    <p class="text-muted small">Ceci arrive généralement quand il manque une virgule ou qu'un ID est en double dans rapports_details.json.</p>
                </div>`;
        }
    }

    function applyFilters() {
        const type = document.getElementById('filterType').value;
        const media = document.getElementById('filterMedia').value;
        const rows = document.querySelectorAll('#tableBody tr');
        rows.forEach(row => {
            const rowType = row.cells[1].innerText;
            const rowMedia = row.cells[2].innerText;
            const tMatch = type === 'tous' || rowType.includes(type);
            const mMatch = media === 'tous' || rowMedia.includes(media);
            row.style.display = (tMatch && mMatch) ? '' : 'none';
        });
        updateCount();
    }

    function updateCount() {
        const visible = document.querySelectorAll('#tableBody tr:not([style*="display: none"])').length;
        document.getElementById('rowCount').innerText = `${visible} rapport(s) affiché(s)`;
    }
</script>
</body>
</html>